<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>TourWaer â€“ Dein Outfit Guide ğŸ¥¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light py-4">
  <div class="container">
    <h1 class="mb-4">ğŸ§¥ TourWaer â€“ Was soll ich anziehen ?</h1>

    <form id="frageForm" class="mb-4">
      <div class="mb-3">
        <label class="form-label">Startort</label>
        <input type="text" class="form-control" id="start" required placeholder="z.â€¯B. Berlin" />
      </div>
      <div class="mb-3">
        <label class="form-label">Zielort</label>
        <input type="text" class="form-control" id="ziel" required placeholder="z.â€¯B. Potsdam" />
      </div>
      <div class="mb-3">
        <label class="form-label">Ich bin unterwegs mit:</label>
        <select class="form-select" id="modus">
          <option value="wandern">Wandern</option>
          <option value="fahrrad">Fahrrad</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Zusatzfrage</label>
        <input type="text" class="form-control" id="frage" placeholder="z.â€¯B. Was soll ich anziehen?" />
      </div>
      <button type="submit" class="btn btn-primary">Absenden</button>
    </form>

    <div id="wetterAnzeige" class="mb-3">
      <p id="wetterStart"></p>
      <p id="wetterZiel"></p>
      <p id="dauerText"></p>
    </div>

    <div id="antwort" class="alert alert-info d-none" role="alert"></div>

    <h4 class="mt-4">âœ… Packliste</h4>
    <ul id="packliste" class="list-group"></ul>

    <div class="mt-4">
      <a id="pdfButton" href="#" target="_blank" class="btn btn-outline-secondary">ğŸ“„ PDF exportieren</a>
      <a id="gpxButton" href="#" class="btn btn-outline-success">ğŸ§­ GPX herunterladen</a>
    </div>

    <div class="mt-3">
      <label for="radiusSlider" class="form-label">
        ğŸ” POI-Suchradius: <span id="radiusValue"><strong>800</strong></span>â€¯m
      </label>
      <input type="range" class="form-range" min="100" max="2000" step="100" value="800" id="radiusSlider">
    </div>

    <h4 class="mt-5">ğŸ—ºï¸ Route & HÃ¶henprofil</h4>
    <div id="karte" style="height: 400px;"></div>
    <canvas id="profil" height="150"></canvas>
  </div>

  <script>
    let map;

    document.getElementById("frageForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const daten = {
        start: document.getElementById("start").value,
        ziel: document.getElementById("ziel").value,
        modus: document.getElementById("modus").value,
        frage: document.getElementById("frage").value
      };

      const res = await fetch("/frage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(daten)
      });

      const data = await res.json();

      document.getElementById("antwort").textContent = data.antwort;
      document.getElementById("antwort").classList.remove("d-none");

      document.getElementById("wetterStart").textContent = "ğŸŒ¤ï¸ Startort: " + data.wetter_start;
      document.getElementById("wetterZiel").textContent  = "ğŸŒ¦ï¸ Zielort: " + data.wetter_ziel;
      document.getElementById("dauerText").textContent   = "â±ï¸ GeschÃ¤tzte Dauer: " + data.dauer + " Stunden";

      const packUl = document.getElementById("packliste");
      packUl.innerHTML = "";
      data.packliste.forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = "âœ… " + item;
        packUl.appendChild(li);
      });

      ladeRoute(daten.start, daten.ziel);

      document.getElementById("pdfButton").href =
        `/export?start=${daten.start}&ziel=${daten.ziel}&modus=${daten.modus}&frage=${encodeURIComponent(daten.frage || "")}`;
    });

    document.getElementById("gpxButton").addEventListener("click", async function(e) {
      e.preventDefault();

      const gpxRes = await fetch("/gpx", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          start: document.getElementById("start").value,
          ziel: document.getElementById("ziel").value
        })
      });

      const blob = await gpxRes.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "tourwaer.gpx";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

document.getElementById("radiusSlider").addEventListener("input", function () {
  document.getElementById("radiusValue").textContent = this.value;
  updatePOIs(); // live POIs nachladen beim Schieben
});

async function ladeRoute(start, ziel) {
  const res = await fetch("/route", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ start, ziel })
  });
  const data = await res.json();
  if (!data.punkte) return;

  const punkte = data.punkte;
  const latlngs = punkte.map(p => [p.lat, p.lon]);

  // Basiskarten vorbereiten
  const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  });

  const topo = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
    maxZoom: 17,
    attribution: "Kartendaten: Â© OpenStreetMap, SRTM | Darstellung: Â© OpenTopoMap"
  });

  // Karte neu erstellen oder ersetzen
  if (map) map.remove();

  map = L.map("karte", {
    center: latlngs[0],
    zoom: 13,
    layers: [topo] // standardmÃ¤ÃŸig TopoMap aktiviert
  });

  const baseMaps = {
    "Standardkarte": osm,
    "Topographisch": topo
  };

  L.control.layers(baseMaps).addTo(map);

  // Route anzeigen
  L.polyline(latlngs, { color: "blue" }).addTo(map);
  L.marker(latlngs[0]).addTo(map).bindPopup("Start").openPopup();
  L.marker(latlngs.at(-1)).addTo(map).bindPopup("Ziel");

  // HÃ¶henprofil
  const eleChart = document.getElementById("profil").getContext("2d");
  const labels = punkte.map((_, i) => i + "");
  const hoehen = punkte.map(p => p.ele);

  const farben = [];
for (let i = 1; i < hoehen.length; i++) {
  const dist = Math.max(1, i); // keine echte Distanz, aber gleichmÃ¤ÃŸiger Index
  const delta = hoehen[i] - hoehen[i - 1];
  const prozent = (delta / dist) * 100;

  if (prozent > 10)      farben.push("red");
  else if (prozent > 5)  farben.push("orange");
  else                   farben.push("green");
}
farben.unshift(farben[0]); // FÃ¼r ersten Punkt


new Chart(eleChart, {
  type: "line",
  data: {
    labels: labels,
    datasets: [{
      label: "HÃ¶henmeter",
      data: hoehen,
      segment: {
        borderColor: ctx => farben[ctx.p1DataIndex]
      },
      borderWidth: 2,
      tension: 0.2
    }]
  },
  options: {
    responsive: true,
    scales: {
      x: { display: false },
      y: { title: { display: true, text: "Meter" } }
    },
    plugins: {
      legend: { display: false }
    }
  }
});


  ladePOIs(start, ziel); // POIs nachladen
}

    async function ladePOIs(start, ziel) {
      const radius = document.getElementById("radiusSlider").value;
      const res = await fetch("/pois", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ start, ziel, distanz: radius })
      });
      const data = await res.json();
      if (!Array.isArray(data)) return;

      const icons = {
        drinking_water: { emoji: "ğŸ’§", color: "blue" },
        picnic_site:    { emoji: "ğŸ§º", color: "green" },
        hut:            { emoji: "ğŸ›–", color: "brown" },
        toilets:        { emoji: "ğŸš»", color: "purple" }
      };

      data.forEach(poi => {
        const info = icons[poi.type] || { emoji: "ğŸ“", color: "gray" };
        const marker = L.circleMarker([poi.lat, poi.lon], {
          radius: 7,
          fillColor: info.color,
          color: "#333",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.9
        }).addTo(map);
        marker.bindPopup(`${info.emoji} ${poi.name || poi.type.replace("_", " ")}`);
      });
    }
  </script>
  <script>
  function updatePOIs() {
    const start = document.getElementById("start").value;
    const ziel  = document.getElementById("ziel").value;

    if (!start || !ziel || !map) return; // kein Reload mÃ¶glich, wenn Route nicht geladen

    ladePOIs(start, ziel);
  }
  </script>>

</body>
</html>
